<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shane Wilson for Ibex: Winter 2026 Market Map</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", sans-serif;
      background: #ffffff;
      padding: 50px 30px;
    }

    .container { max-width: 1600px; margin: 0 auto; }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 30px;
      border-bottom: 2px solid #f0f0f0;
    }

    .header h1 {
      font-size: 48px;
      font-weight: 700;
      color: #6B46C1;
      margin-bottom: 12px;
      letter-spacing: -0.5px;
      line-height: 1.2;
    }

    .header .subtitle {
      font-size: 18px;
      color: #666;
      font-weight: 400;
      margin-top: 10px;
    }

    .nav-links { text-align: center; margin: 18px 0 26px 0; }

    .nav-links a {
      display: inline-block;
      padding: 10px 24px;
      margin: 0 10px;
      background: rgba(124, 58, 237, 0.1);
      color: #7C3AED;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      font-size: 15px;
      transition: all 0.3s ease;
    }

    .nav-links a:hover { background: #7C3AED; color: white; }
    .nav-links a.active { background: #7C3AED; color: white; }

    /* --- Status --- */
    .status {
      max-width: 1100px;
      margin: 0 auto 18px auto;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid #eee;
      background: #fafafa;
      color: #374151;
      font-size: 14px;
      line-height: 1.35;
    }
    .status strong { color: #111827; }
    .status.error { border-color: #fecaca; background: #fff1f2; color: #991b1b; }
    .status.ok { border-color: #d1fae5; background: #ecfdf5; color: #065f46; }
    .status .muted { color: #6b7280; }

    /* --- Controls --- */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin: 18px auto 22px auto;
      max-width: 1400px;
    }

    .search {
      flex: 1 1 420px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .search input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 14px;
      outline: none;
    }

    .pillbar {
      flex: 1 1 520px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-end;
    }

    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #e9d5ff;
      background: rgba(124, 58, 237, 0.06);
      color: #6B46C1;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
      text-decoration: none;
    }

    .pill:hover { background: rgba(124, 58, 237, 0.12); }
    .pill.active { background: #7C3AED; color: white; border-color: #7C3AED; }

    /* --- Sections --- */
    .section {
      margin: 30px auto 22px auto;
      max-width: 1600px;
    }

    .section-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 14px;
      padding: 0 6px;
    }

    .section-title {
      font-size: 22px;
      font-weight: 700;
      color: #111827;
    }

    .section-count {
      font-size: 13px;
      color: #6b7280;
      font-weight: 600;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 14px;
    }

    @media (max-width: 1400px) { .grid { grid-template-columns: repeat(5, 1fr); } }
    @media (max-width: 1200px) { .grid { grid-template-columns: repeat(4, 1fr); } }
    @media (max-width: 900px)  { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 520px)  { .grid { grid-template-columns: repeat(1, 1fr); } }

    /* --- Company cards --- */
    .card {
      position: relative;
      background: white;
      border: 2px solid #E9D5FF;
      border-radius: 14px;
      padding: 16px 14px;
      min-height: 130px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.25s ease;
      overflow: visible;
      text-align: center;
    }

    .card:hover {
      border-color: #7C3AED;
      box-shadow: 0 6px 18px rgba(124, 58, 237, 0.14);
      transform: translateY(-2px);
    }

    .logo {
      width: 64px;
      height: 64px;
      object-fit: contain;
      margin-bottom: 10px;
    }

    .placeholder {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(167, 139, 250, 0.1) 100%);
      border-radius: 10px;
      display: none;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      font-size: 12px;
      color: #7C3AED;
      font-weight: 700;
      padding: 8px;
      line-height: 1.2;
    }

    .name {
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      line-height: 1.25;
      word-break: break-word;
    }

    /* Tooltip */
    .tooltip {
      position: absolute;
      left: 50%;
      bottom: calc(100% + 12px);
      transform: translateX(-50%);
      width: 360px;
      max-width: 520px;
      background: rgba(17, 24, 39, 0.95);
      color: white;
      padding: 14px 14px;
      border-radius: 12px;
      font-size: 12.5px;
      line-height: 1.35;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease, transform 0.15s ease;
      z-index: 9999;
      text-align: left;
    }

    .tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 8px;
      border-style: solid;
      border-color: rgba(17, 24, 39, 0.95) transparent transparent transparent;
    }

    .card:hover .tooltip {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    .tooltip h4 {
      font-size: 13px;
      margin-bottom: 8px;
      font-weight: 800;
    }

    .tooltip .content {
      opacity: 0.95;
      max-height: 220px;
      overflow: auto;
      white-space: normal;
    }

    .footer {
      text-align: center;
      margin-top: 60px;
      padding-top: 40px;
      border-top: 2px solid #f0f0f0;
    }

    .footer-branding { font-size: 14px; color: #9ca3af; }

    @media print { body { padding: 20px; } }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1 id="page-title">Shane Wilson for Ibex: Winter 2026 Market Map</h1>
      <div class="subtitle" id="page-subtitle">Landscape of relevant companies, grouped by category</div>

      <div class="nav-links">
        <a class="active" href="index.html">Market Map</a>
        <a href="sales_funnel.html">Deal Flow →</a>
      </div>
    </div>

    <div id="status" class="status">
      <strong>Loading data</strong>
      <div class="muted">If this hangs, the endpoint URL is wrong or blocked.</div>
    </div>

    <div class="controls">
      <div class="search">
        <input id="search" type="text" placeholder="Search companies (name, about, category)" />
      </div>
      <div class="pillbar" id="pillbar"></div>
    </div>

    <div id="sections"></div>

    <div class="footer">
      <div class="footer-branding" id="footer-text">© 2026 IBEX Investors, Inc. | Winter 2026</div>
    </div>
  </div>

  <script>
    const CONFIG = {
      endpointBase: "https://script.google.com/macros/s/AKfycbzrHCcoWxGkVJ96Q-D-IZb-NAX58ONk9vJinZB5avr1TvOLbeW-ToFUQ3e5hDbfGZB_/exec",
      view: "marketmap",

      pageTitle: "Shane Wilson for Ibex: Winter 2026 Market Map",
      pageSubtitle: "Landscape of relevant companies, grouped by category",
      footerText: "© 2026 IBEX Investors, Inc. | Winter 2026"
    };

    function $(id) { return document.getElementById(id); }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function setStatus(type, title, details) {
      const el = $("status");
      el.className = "status " + (type || "");
      el.innerHTML = `<strong>${escapeHtml(title)}</strong>${details ? `<div class="muted">${escapeHtml(details)}</div>` : ""}`;
    }

    function safeOpen(url) {
      if (!url) return;
      try {
        const u = new URL(url, window.location.href);
        window.open(u.href, "_blank", "noopener,noreferrer");
      } catch (e) {}
    }

    function slugify(s) {
      return String(s || "")
        .toLowerCase()
        .trim()
        .replace(/&/g, "and")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
    }

    function loadJsonp(url, callbackName) {
      return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = url;
        script.async = true;

        const timeout = setTimeout(() => {
          cleanup();
          reject(new Error("JSONP request timed out"));
        }, 15000);

        function cleanup() {
          clearTimeout(timeout);
          script.remove();
          try { delete window[callbackName]; } catch (e) { window[callbackName] = undefined; }
        }

        window[callbackName] = (data) => {
          cleanup();
          resolve(data);
        };

        script.onerror = () => {
          cleanup();
          reject(new Error("Failed to load JSONP script"));
        };

        document.head.appendChild(script);
      });
    }

    function makePill(text, href, isActive) {
      const a = document.createElement("a");
      a.className = "pill" + (isActive ? " active" : "");
      a.href = href;
      a.textContent = text;
      return a;
    }

    function makeCard(company, category) {
      const name = String(company["Company Name"] || "").trim() || "Unknown";
      const url = String(company["Url"] || "").trim();
      const logo = String(company["Logo link"] || "").trim();
      const about = String(company["About"] || "").trim();

      const card = document.createElement("div");
      card.className = "card";
      card.tabIndex = 0;
      card.setAttribute("role", "button");
      card.setAttribute("aria-label", name);

      card.addEventListener("click", () => safeOpen(url));
      card.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          safeOpen(url);
        }
      });

      const img = document.createElement("img");
      img.className = "logo";
      img.alt = name;
      img.src = logo || "";
      img.style.display = logo ? "block" : "none";

      const placeholder = document.createElement("div");
      placeholder.className = "placeholder";
      placeholder.style.display = logo ? "none" : "flex";
      placeholder.textContent = name;

      img.onerror = () => {
        img.style.display = "none";
        placeholder.style.display = "flex";
      };

      const title = document.createElement("div");
      title.className = "name";
      title.textContent = name;

      const tooltip = document.createElement("div");
      tooltip.className = "tooltip";

      const h4 = document.createElement("h4");
      h4.textContent = name;

      const content = document.createElement("div");
      content.className = "content";
      const text = about ? about : "No description available.";
      content.innerHTML = escapeHtml(text).replaceAll("\n", "<br>");

      tooltip.appendChild(h4);
      tooltip.appendChild(content);

      card.appendChild(img);
      card.appendChild(placeholder);
      card.appendChild(title);
      card.appendChild(tooltip);

      return card;
    }

    function render(payload) {
      const mm = payload.marketMapData || {};
      const categories = Object.keys(mm);

      // Controls
      const pillbar = $("pillbar");
      pillbar.innerHTML = "";

      pillbar.appendChild(makePill("All", "#all", true));
      for (const cat of categories) {
        pillbar.appendChild(makePill(cat, "#" + slugify(cat), false));
      }

      // Sections
      const sections = $("sections");
      sections.innerHTML = "";

      for (const cat of categories) {
        const items = Array.isArray(mm[cat]) ? mm[cat] : [];
        const section = document.createElement("div");
        section.className = "section";
        section.id = slugify(cat);

        const header = document.createElement("div");
        header.className = "section-header";

        const title = document.createElement("div");
        title.className = "section-title";
        title.textContent = cat;

        const count = document.createElement("div");
        count.className = "section-count";
        count.textContent = items.length + " companies";

        header.appendChild(title);
        header.appendChild(count);

        const grid = document.createElement("div");
        grid.className = "grid";

        items.forEach(c => grid.appendChild(makeCard(c, cat)));

        section.appendChild(header);
        section.appendChild(grid);
        sections.appendChild(section);
      }

      // Search filtering
      const search = $("search");
      const doFilter = () => {
        const q = search.value.trim().toLowerCase();
        const allSections = sections.querySelectorAll(".section");

        allSections.forEach(sec => {
          const cards = sec.querySelectorAll(".card");
          let visible = 0;

          cards.forEach(card => {
            const name = (card.querySelector(".name")?.textContent || "").toLowerCase();
            const tip = (card.querySelector(".tooltip .content")?.textContent || "").toLowerCase();
            const cat = (sec.querySelector(".section-title")?.textContent || "").toLowerCase();

            const ok = !q || name.includes(q) || tip.includes(q) || cat.includes(q);
            card.style.display = ok ? "" : "none";
            if (ok) visible++;
          });

          sec.style.display = visible ? "" : "none";
          const countEl = sec.querySelector(".section-count");
          if (countEl) countEl.textContent = visible + " companies";
        });
      };

      search.addEventListener("input", doFilter);

      // Hash navigation highlighting
      function setActivePill() {
        const hash = (location.hash || "#all").replace("#", "");
        const pills = pillbar.querySelectorAll(".pill");
        pills.forEach(p => p.classList.remove("active"));

        const target = Array.from(pills).find(p => (p.getAttribute("href") || "") === "#" + hash);
        (target || pills[0])?.classList.add("active");
      }

      window.addEventListener("hashchange", setActivePill);
      setActivePill();
    }

    async function load() {
      $("page-title").textContent = CONFIG.pageTitle;
      $("page-subtitle").textContent = CONFIG.pageSubtitle;
      $("footer-text").textContent = CONFIG.footerText;

      setStatus("", "Loading data", "Fetching from Apps Script (JSONP)");

      const cbName = "handleMarketMapPayload_" + Math.random().toString(16).slice(2);
      const url = `${CONFIG.endpointBase}?view=${encodeURIComponent(CONFIG.view)}&callback=${encodeURIComponent(cbName)}&t=${Date.now()}`;

      let payload;
      try {
        payload = await loadJsonp(url, cbName);
      } catch (err) {
        setStatus("error", "Failed to load data", String(err));
        return;
      }

      if (!payload || payload.ok !== true) {
        const msg = payload && payload.error ? payload.error : "Unknown error";
        setStatus("error", "Endpoint returned an error", msg);
        return;
      }

      render(payload);

      const ts = String(payload?.meta?.timestamp || "");
      const rows = String(payload?.meta?.rows ?? "");
      setStatus("ok", "Loaded successfully", `Rows: ${rows}. Timestamp: ${ts}`);
    }

    load();
  </script>
</body>
</html>
