<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shane Wilson for Ibex: Winter 2026 Deal Flow</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", sans-serif;
      background: #ffffff;
      padding: 50px 30px;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    .header {
      text-align: center;
      margin-bottom: 60px;
      padding-bottom: 30px;
      border-bottom: 2px solid #f0f0f0;
    }

    .header h1 {
      font-size: 48px;
      font-weight: 700;
      color: #6B46C1;
      margin-bottom: 12px;
      letter-spacing: -0.5px;
      line-height: 1.2;
    }

    .header .subtitle {
      font-size: 18px;
      color: #666;
      font-weight: 400;
      margin-top: 10px;
    }

    .nav-links { text-align: center; margin-bottom: 40px; }

    .nav-links a {
      display: inline-block;
      padding: 10px 24px;
      margin: 0 10px;
      background: rgba(124, 58, 237, 0.1);
      color: #7C3AED;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      font-size: 15px;
      transition: all 0.3s ease;
    }

    .nav-links a:hover { background: #7C3AED; color: white; }
    .nav-links a.active { background: #7C3AED; color: white; }

    /* --- Status / errors --- */
    .status {
      max-width: 980px;
      margin: 0 auto 20px auto;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid #eee;
      background: #fafafa;
      color: #374151;
      font-size: 14px;
      line-height: 1.35;
    }
    .status strong { color: #111827; }
    .status.error { border-color: #fecaca; background: #fff1f2; color: #991b1b; }
    .status.ok { border-color: #d1fae5; background: #ecfdf5; color: #065f46; }
    .status .muted { color: #6b7280; }

    /* --- Funnel --- */
    .funnel-wrapper {
      max-width: 820px;
      margin: 30px auto 30px auto;
      position: relative;
      z-index: 1;
    }

    .funnel-stage {
      position: relative;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 110px;
    }

    .stage-1 {
      width: 760px;
      height: 120px;
      background: linear-gradient(135deg, #7C3AED 0%, #A78BFA 100%);
      clip-path: polygon(6% 0%, 94% 0%, 88% 100%, 12% 100%);
      box-shadow: 0 4px 20px rgba(124, 58, 237, 0.2);
      margin: 0 auto;
    }

    .stage-2 {
      width: 600px;
      height: 120px;
      background: linear-gradient(135deg, #8B5CF6 0%, #C4B5FD 100%);
      clip-path: polygon(8% 0%, 92% 0%, 84% 100%, 16% 100%);
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.2);
      margin: -8px auto 0 auto;
    }

    .stage-3 {
      width: 450px;
      height: 120px;
      background: linear-gradient(135deg, #9333EA 0%, #D8B4FE 100%);
      clip-path: polygon(12% 0%, 88% 0%, 78% 100%, 22% 100%);
      box-shadow: 0 4px 20px rgba(147, 51, 234, 0.2);
      margin: -8px auto 0 auto;
    }

    .stage-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      text-align: center;
      width: 100%;
      z-index: 5;
      pointer-events: none;
    }

    .stage-label {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 0.3px;
      margin-bottom: 8px;
    }

    .stage-count { font-size: 42px; font-weight: 700; }

    /* --- Call Executed cards --- */
    .diligence-companies {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 20px;
      margin-top: 60px;
      padding: 0 6%;
      position: relative;
      z-index: 10;
    }

    .diligence-card {
      overflow: visible;
      position: relative;
      background: white;
      border: 2px solid #E9D5FF;
      border-radius: 12px;
      padding: 24px 20px;
      text-align: center;
      transition: all 0.3s ease;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .diligence-card:hover {
      border-color: #7C3AED;
      box-shadow: 0 4px 16px rgba(124, 58, 237, 0.15);
      transform: translateY(-3px);
    }

    .diligence-logo {
      width: 80px;
      height: 80px;
      object-fit: contain;
      margin-bottom: 12px;
    }

    .diligence-placeholder {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(167, 139, 250, 0.1) 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
      font-size: 14px;
      color: #7C3AED;
      font-weight: 600;
      text-align: center;
      line-height: 1.3;
      padding: 10px;
    }

    .diligence-name {
      font-size: 14px;
      color: #374151;
      font-weight: 500;
      line-height: 1.3;
    }

    /* --- Tooltip --- */
    .tooltip {
      position: absolute;
      left: 50%;
      bottom: calc(100% + 14px);
      transform: translateX(-50%);
      width: 340px;
      max-width: 520px;
      background: rgba(17, 24, 39, 0.95);
      color: white;
      padding: 14px 14px;
      border-radius: 12px;
      font-size: 12.5px;
      line-height: 1.35;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease, transform 0.15s ease;
      z-index: 9999;
    }

    .tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 8px;
      border-style: solid;
      border-color: rgba(17, 24, 39, 0.95) transparent transparent transparent;
    }

    .diligence-card:hover .tooltip {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    .tooltip h4 {
      font-size: 13px;
      margin-bottom: 8px;
      font-weight: 700;
    }

    .tooltip .section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      opacity: 0.8;
      margin-top: 10px;
      margin-bottom: 4px;
      font-weight: 700;
    }

    .tooltip .content {
      opacity: 0.95;
      max-height: 220px;
      overflow: auto;
      white-space: normal;
    }

    /* --- Metrics --- */
    .metrics-row {
      display: flex;
      justify-content: center;
      gap: 80px;
      margin-top: 60px;
      padding: 40px;
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.05) 0%, rgba(167, 139, 250, 0.05) 100%);
      border-radius: 16px;
    }

    .metric { text-align: center; }

    .metric-value {
      font-size: 42px;
      font-weight: 700;
      color: #7C3AED;
      margin-bottom: 8px;
    }

    .metric-label {
      font-size: 14px;
      color: #666;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .footer {
      text-align: center;
      margin-top: 60px;
      padding-top: 40px;
      border-top: 2px solid #f0f0f0;
    }

    .footer-branding { font-size: 14px; color: #9ca3af; }

    @media print { body { padding: 20px; } }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1 id="page-title">Shane Wilson for Ibex: Winter 2026 Deal Flow</h1>
      <div class="subtitle" id="page-subtitle">Evaluation Pipeline &amp; Company Progression</div>
    </div>

    <div class="nav-links">
      <a href="index.html">← Market Map</a>
      <a class="active" href="sales_funnel.html">Deal Flow</a>
    </div>

    <div id="status" class="status">
      <strong>Loading data</strong>
      <div class="muted">If this hangs, your fetch URL is wrong or blocked by CORS.</div>
    </div>

    <div class="funnel-wrapper">
      <div class="funnel-stage">
        <div class="stage-1"></div>
        <div class="stage-content">
          <div class="stage-label">Contacted</div>
          <div class="stage-count" id="count-contacted">0</div>
        </div>
      </div>

      <div class="funnel-stage">
        <div class="stage-2"></div>
        <div class="stage-content">
          <div class="stage-label">Connected</div>
          <div class="stage-count" id="count-connected">0</div>
        </div>
      </div>

      <div class="funnel-stage">
        <div class="stage-3"></div>
        <div class="stage-content">
          <div class="stage-label">Call Executed</div>
          <div class="stage-count" id="count-call-executed">0</div>
        </div>
      </div>
    </div>

    <div class="diligence-companies" id="call-executed-grid"></div>

    <div class="metrics-row">
      <div class="metric">
        <div class="metric-value" id="metric-connection-rate">0.0%</div>
        <div class="metric-label">Connection Rate</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="metric-call-executed-rate">0.0%</div>
        <div class="metric-label">Call Executed Rate</div>
      </div>
    </div>

    <div class="footer">
      <div class="footer-branding" id="footer-text">© 2026 IBEX Investors, Inc. | Winter 2026</div>
    </div>
  </div>

  <script>
    /**
     * =========================
     * CONFIG (edit this only)
     * =========================
     */
    const CONFIG = {
      dataUrl: "./data/companies.json",

      // Optional: for display only
      pageTitle: "Shane Wilson for Ibex: Winter 2026 Deal Flow",
      pageSubtitle: "Evaluation Pipeline & Company Progression",
      footerText: "© 2026 IBEX Investors, Inc. | Winter 2026",

      // If your source uses different field names, map them here.
      // Left side is "canonical name used by this page". Right side is "field in your JSON".
      fieldMap: {
        name: "name",
        category: "category",
        website: "website",
        logo: "logo",
        connected: "connected",
        callExecuted: "call_executed",
        callNotes: "call_notes",
        decision: "decision",
        reason: "reason"
      },

      // How to interpret "truthy" flags from the source
      truthyValues: new Set([1, "1", true, "true", "TRUE", "yes", "YES", "y", "Y"]),

      // Contacted definition:
      // - "all" means every row in the dataset counts as contacted
      // - "nonEmptyName" means only rows with name count as contacted
      contactedMode: "all",

      // Grid settings
      maxCards: null // e.g. 10 to cap, or null for unlimited
    };

    /**
     * =========================
     * HELPERS
     * =========================
     */
    function $(id) { return document.getElementById(id); }

    function setStatus(type, title, details) {
      const el = $("status");
      el.className = "status " + (type || "");
      el.innerHTML = `<strong>${escapeHtml(title)}</strong>${details ? `<div class="muted">${escapeHtml(details)}</div>` : ""}`;
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normCompany(raw) {
      const m = CONFIG.fieldMap;

      const get = (canonical) => raw?.[m[canonical]];
      const toStr = (v) => (v === null || v === undefined) ? "" : String(v);

      const company = {
        name: toStr(get("name")).trim(),
        category: toStr(get("category")).trim(),
        website: toStr(get("website")).trim(),
        logo: toStr(get("logo")).trim(),
        connected: get("connected"),
        callExecuted: get("callExecuted"),
        callNotes: toStr(get("callNotes")).trim(),
        decision: toStr(get("decision")).trim(),
        reason: toStr(get("reason")).trim()
      };

      return company;
    }

    function isTruthy(v) {
      if (typeof v === "string") return CONFIG.truthyValues.has(v.trim());
      return CONFIG.truthyValues.has(v);
    }

    function pct(n, d) {
      if (!d) return "0.0%";
      const val = (n / d) * 100;
      return `${val.toFixed(1)}%`;
    }

    function buildDisplayName(company) {
      const name = company.name || "Unknown";
      const cat = company.category ? ` (${company.category})` : "";
      return `${name}${cat}`;
    }

    function safeOpen(url) {
      if (!url) return;
      try {
        const u = new URL(url, window.location.href);
        window.open(u.href, "_blank", "noopener,noreferrer");
      } catch (e) {
        // ignore invalid URL
      }
    }

    function makeCard(company) {
      const displayName = buildDisplayName(company);
      const hasLogo = Boolean(company.logo);

      const card = document.createElement("div");
      card.className = "diligence-card";
      card.tabIndex = 0;
      card.setAttribute("role", "button");
      card.setAttribute("aria-label", displayName);

      const clickUrl = company.website;
      card.addEventListener("click", () => safeOpen(clickUrl));
      card.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          safeOpen(clickUrl);
        }
      });

      // Logo or placeholder
      const img = document.createElement("img");
      img.className = "diligence-logo";
      img.alt = displayName;
      img.src = hasLogo ? company.logo : "";
      img.style.display = hasLogo ? "block" : "none";

      const placeholder = document.createElement("div");
      placeholder.className = "diligence-placeholder";
      placeholder.style.display = hasLogo ? "none" : "flex";
      placeholder.textContent = displayName;

      img.onerror = () => {
        img.style.display = "none";
        placeholder.style.display = "flex";
      };

      const nameEl = document.createElement("div");
      nameEl.className = "diligence-name";
      nameEl.textContent = displayName;

      const tooltip = document.createElement("div");
      tooltip.className = "tooltip";

      const h4 = document.createElement("h4");
      h4.textContent = displayName;

      const callTitle = document.createElement("div");
      callTitle.className = "section-title";
      callTitle.textContent = "Call Notes";

      const callContent = document.createElement("div");
      callContent.className = "content";
      callContent.innerHTML = escapeHtml(company.callNotes).replaceAll("\n", "<br>");

      const decisionTitle = document.createElement("div");
      decisionTitle.className = "section-title";
      decisionTitle.textContent = "Decision + Reason";

      const decisionContent = document.createElement("div");
      decisionContent.className = "content";
      const combinedDecision = [
        company.decision ? company.decision : "",
        company.reason ? (company.decision ? "\n\n" + company.reason : company.reason) : ""
      ].join("");
      decisionContent.innerHTML = escapeHtml(combinedDecision).replaceAll("\n", "<br>");

      tooltip.appendChild(h4);
      tooltip.appendChild(callTitle);
      tooltip.appendChild(callContent);
      tooltip.appendChild(decisionTitle);
      tooltip.appendChild(decisionContent);

      card.appendChild(img);
      card.appendChild(placeholder);
      card.appendChild(nameEl);
      card.appendChild(tooltip);

      return card;
    }

    /**
     * =========================
     * MAIN
     * =========================
     */
    async function loadAndRender() {
      // Static display text
      $("page-title").textContent = CONFIG.pageTitle;
      $("page-subtitle").innerHTML = CONFIG.pageSubtitle;
      $("footer-text").textContent = CONFIG.footerText;

      setStatus("", "Loading data", "Fetching companies from " + CONFIG.dataUrl);

      let raw;
      try {
        const res = await fetch(CONFIG.dataUrl, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        raw = await res.json();
      } catch (err) {
        setStatus("error", "Failed to load data", String(err));
        return;
      }

      if (!Array.isArray(raw)) {
        setStatus("error", "Data format error", "Expected an array of companies. Got: " + typeof raw);
        return;
      }

      const companies = raw.map(normCompany);

      // Contacted definition
      const contacted = (CONFIG.contactedMode === "nonEmptyName")
        ? companies.filter(c => c.name).length
        : companies.length;

      const connectedCount = companies.filter(c => isTruthy(c.connected)).length;
      const callExecutedCompanies = companies.filter(c => isTruthy(c.callExecuted));
      const callExecutedCount = callExecutedCompanies.length;

      $("count-contacted").textContent = String(contacted);
      $("count-connected").textContent = String(connectedCount);
      $("count-call-executed").textContent = String(callExecutedCount);

      $("metric-connection-rate").textContent = pct(connectedCount, contacted);
      $("metric-call-executed-rate").textContent = pct(callExecutedCount, contacted);

      // Render call executed grid
      const grid = $("call-executed-grid");
      grid.innerHTML = "";

      let toRender = callExecutedCompanies;
      if (typeof CONFIG.maxCards === "number") {
        toRender = toRender.slice(0, CONFIG.maxCards);
      }

      if (toRender.length === 0) {
        const empty = document.createElement("div");
        empty.className = "status";
        empty.style.gridColumn = "1 / -1";
        empty.innerHTML = "<strong>No Call Executed companies found</strong><div class='muted'>Check your fieldMap for callExecuted and confirm the source values match truthyValues.</div>";
        grid.appendChild(empty);
      } else {
        toRender.forEach(c => grid.appendChild(makeCard(c)));
      }

      setStatus("ok", "Loaded successfully", `Companies: ${companies.length}. Connected: ${connectedCount}. Call Executed: ${callExecutedCount}.`);
    }

    loadAndRender();
  </script>
</body>
</html>
